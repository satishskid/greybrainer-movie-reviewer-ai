rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection - users can read/write their own data, admins can read all
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && isAdmin();
    }
    
    // Whitelist collection - only admins can manage
    match /whitelist/{email} {
      allow read, write: if request.auth != null && isAdmin();
    }
    
    // Reports collection - different permissions based on status
    match /reports/{reportId} {
      // Anyone authenticated can read published reports
      allow read: if request.auth != null && resource.data.status == 'published';
      
      // Authors can read their own drafts
      allow read: if request.auth != null && 
                     (resource.data.authorId == request.auth.uid || 
                      resource.data.authorEmail == request.auth.token.email);
      
      // Authors can create and update their own reports (but not publish)
      allow create: if request.auth != null && 
                       request.resource.data.authorId == request.auth.uid &&
                       request.resource.data.status in ['draft', 'in_review'];
      
      // Admins can create any reports (including during initialization)
      allow create: if request.auth != null && isAdmin();
      
      allow update: if request.auth != null && 
                       (resource.data.authorId == request.auth.uid || 
                        resource.data.authorEmail == request.auth.token.email) &&
                       request.resource.data.status in ['draft', 'in_review'];
      
      // Editors can read and update reports for review
      allow read, update: if request.auth != null && isEditor();
      
      // Admins can do everything
      allow read, write: if request.auth != null && isAdmin();
    }
    
    // Subscribers collection - public write for subscriptions, admin read
    match /subscribers/{email} {
      allow create: if true; // Anyone can subscribe
      allow read, update, delete: if request.auth != null && isAdmin();
    }
    
    // Analytics collection - admin only
    match /analytics/{document} {
      allow read, write: if request.auth != null && isAdmin();
    }
    
    // System collection - admin only (for initialization)
    match /system/{document} {
      allow read, write: if request.auth != null && isAdmin();
    }
    
    // Monthly Scoreboards collection - admin write, authenticated read
    match /monthlyScoreboards/{scoreboardId} {
      // Anyone authenticated can read published scoreboards
      allow read: if request.auth != null;
      
      // Only admins can create and update monthly scoreboards
      allow create, update: if request.auth != null && isAdmin();
      
      // Only admins can delete scoreboards
      allow delete: if request.auth != null && isAdmin();
    }
    
    // Helper functions
    function isAdmin() {
      return request.auth.token.email in [
        'satish@skids.health',
        'satish.rath@gmail.com', 
        'dr.satish@greybrain.ai'
      ];
    }
    
    function isEditor() {
      return request.auth.token.email in [
        'drpratichi@skids.health',
        'saminamisra@gmail.com'
      ] || isAdmin();
    }
    
    function isWhitelisted() {
      return exists(/databases/$(database)/documents/whitelist/$(request.auth.token.email)) &&
             get(/databases/$(database)/documents/whitelist/$(request.auth.token.email)).data.isActive == true;
    }
  }
}